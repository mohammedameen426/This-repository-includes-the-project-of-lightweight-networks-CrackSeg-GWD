# Group Normalization
class GroupNormalization(layers.Layer):
    def __init__(self, groups=32, axis=-1, epsilon=1e-5, **kwargs):
        super().__init__(**kwargs)
        self.groups = groups
        self.axis = axis
        self.epsilon = epsilon

    def build(self, input_shape):
        dim = input_shape[self.axis]
        if dim is None:
            raise ValueError("Axis dimension must be defined.")
        if dim % self.groups != 0:
            raise ValueError(f"{dim} channels not divisible by {self.groups} groups.")
        self.gamma = self.add_weight(shape=(dim,), initializer="ones", name="gamma")
        self.beta = self.add_weight(shape=(dim,), initializer="zeros", name="beta")
        super().build(input_shape)

    def call(self, inputs):
        N, H, W, C = tf.shape(inputs)[0], tf.shape(inputs)[1], tf.shape(inputs)[2], tf.shape(inputs)[3]
        G = self.groups
        x = tf.reshape(inputs, [N, H, W, G, C // G])
        mean, var = tf.nn.moments(x, [1,2,4], keepdims=True)
        x = (x - mean) / tf.sqrt(var + self.epsilon)
        x = tf.reshape(x, [N, H, W, C])
        return x * self.gamma + self.beta
